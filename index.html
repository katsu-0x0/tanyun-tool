<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">

  <!-- iPhone 入力時ズーム防止 -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>タンユン体力計算</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 420px;
      margin: 0 auto;
      overflow-x: hidden;
      padding: 6px;
    }

    h2 {
      text-align: center;
      font-size: 18px;
      margin: 6px 0 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }

    /* 左:右 = 60:40 */
    colgroup col:first-child { width: 60%; }
    colgroup col:last-child  { width: 40%; }

    td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 13px;
      overflow: hidden;
      word-break: break-word;
    }

    .input  { background: #ffe5cc; }
    .fixed  { background: #e0e0e0; }
    .result { background: #dbe9ff; font-weight: bold; }

    /* 入力ズーム防止 */
    input {
      font-size: 16px !important;
      width: 100%;
      box-sizing: border-box;
    }

    .stage-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stage-wrap input {
      width: 70px;
      flex-shrink: 0;
    }

    /* プレーンな注意文 */
    .plain-memo {
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.5;
    }
  </style>
</head>
<body>

<h2>タンユン体力計算</h2>

<table>
  <colgroup>
    <col>
    <col>
  </colgroup>

  <tr>
    <td class="fixed">現在時刻</td>
    <td><input class="input" type="time" id="currentTime" step="60"></td>
  </tr>

  <tr>
    <td class="fixed">現在ステージ</td>
    <td>
      <div class="stage-wrap">
        <input class="input" type="number" id="currentStage" min="1" max="10" placeholder="例:6">
        <span>ステージ</span>
      </div>
    </td>
  </tr>

  <tr>
    <td class="fixed">現在ステージ得点</td>
    <td><input class="input" type="number" id="currentStagePoint" placeholder="例:1200"></td>
  </tr>

  <tr>
    <td class="fixed">現在体力</td>
    <td><input class="input" type="number" id="currentStamina" placeholder="例:80"></td>
  </tr>

  <tr>
    <td class="fixed">手持ち枚数</td>
    <td><input class="input" type="number" id="ticketCount" placeholder="例:6"></td>
  </tr>

  <tr>
    <td class="fixed">回復アイテム数</td>
    <td><input class="input" type="number" id="itemCount" placeholder="例:3"></td>
  </tr>

  <tr>
    <td class="result">時間回復含む想定獲得ポイント数</td>
    <td class="result" id="totalPoint">-</td>
  </tr>

  <tr>
    <td class="result">想定到達ステージ</td>
    <td class="result" id="clearStage">-</td>
  </tr>

  <tr>
    <td class="result">次ステージまでに必要な体力</td>
    <td class="result" id="needStamina">-</td>
  </tr>
</table>

<div class="plain-memo">
  ※ ステージ9クリアポイントが不明なため、情報提供ください。<br>
  　 現在の9ステージクリアポイントは仮設定です。<br>
  　 現在時刻から回復体力を出すためHP1程度の誤差があります。
</div>

<script>
  const hiddenEndTime = "22:00";

  const stageClearPointTable = {
    1: 0,
    2: 360,
    3: 1440,
    4: 2700,
    5: 4560,
    6: 6600,
    7: 8880,
    8: 11400,
    9: 14460,
    10: 17860
  };

  function setNowTime() {
    const now = new Date();
    document.getElementById("currentTime").value =
      now.toTimeString().slice(0, 5);
  }

  function calc() {
    const now = new Date();
    const timeValue = document.getElementById("currentTime").value;
    if (!timeValue) return;

    const [ch, cm] = timeValue.split(":").map(Number);

    const currentDate = new Date(now);
    currentDate.setHours(ch, cm, 0, 0);

    const [eh, em] = hiddenEndTime.split(":").map(Number);
    const endDate = new Date(now);
    endDate.setHours(eh, em, 0, 0);

    const remainMin = Math.max(0, (endDate - currentDate) / 60000);
    const futureRecovery = Math.floor(remainMin / 2); // 2分で1回復

    const currentStamina = Number(document.getElementById("currentStamina").value) || 0;
    const ticketCount = Number(document.getElementById("ticketCount").value) || 0;
    const itemCount = Number(document.getElementById("itemCount").value) || 0;
    const currentStage = Number(document.getElementById("currentStage").value) || 1;
    const currentStagePoint = Number(document.getElementById("currentStagePoint").value) || 0;

    const totalStamina =
      currentStamina +
      futureRecovery +
      ticketCount +
      (itemCount * 10);

    const staminaPoint = totalStamina * 20;

    /* ===== 合計ポイント ===== */
    const entryBasePoint = stageClearPointTable[currentStage] || 0;
    const totalPoint = staminaPoint + entryBasePoint + currentStagePoint;

    /* ===== 想定到達ステージ（totalPoint 基準）===== */
    let maxStage = currentStage;
    for (const stage in stageClearPointTable) {
      if (totalPoint >= stageClearPointTable[stage]) {
        maxStage = Number(stage);
      }
    }

    /* ===== 次ステージに必要な体力（totalPoint 基準）===== */
    const nextStage = maxStage + 1;
    const nextClearPoint = stageClearPointTable[nextStage];

    let needStamina = "-";
    if (nextClearPoint !== undefined) {
      const needPoint = nextClearPoint - totalPoint;
      needStamina = needPoint > 0 ? Math.ceil(needPoint / 20) : 0;
    }

    document.getElementById("totalPoint").textContent = totalPoint + " 点";
    document.getElementById("clearStage").textContent = maxStage + " ステージ";
    document.getElementById("needStamina").textContent = "HP " + needStamina;
  }

  setNowTime();
  setInterval(calc, 1000);
  calc();
</script>

</body>
</html>
